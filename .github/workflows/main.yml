name: Universal QA System

on:
  push:
    paths:
      - 'docker/**'
      - '**.cpp'
      - '**.py'
      - '**.m'
      - '**.tex'

jobs:
  qa-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Codice
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Trova File Modificato
        id: find
        run: |
          # Cerchiamo il file ignorando SEMPRE tester.cpp e la cartella docker
          TARGET=$(git diff --name-only HEAD^ HEAD 2>/dev/null | grep -E '\.(cpp|py|m|tex)$' | grep -v "tester.cpp" | grep -v "docker/" | head -1) || true
          
          if [ -z "$TARGET" ]; then
             TARGET=$(find . -maxdepth 1 -type f | grep -E '\.(cpp|py|m|tex)$' | grep -v "tester.cpp" | head -1 | sed 's|./||')
          fi

          if [ -z "$TARGET" ]; then
             echo "âŒ Nessun file valido da testare."
             exit 1
          else
             echo "target=$TARGET" >> $GITHUB_OUTPUT
          fi

      - name: Build Engine
        run: docker build -t qa-engine -f docker/Dockerfile .

      - name: Run Engine
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/github/workspace \
            qa-engine ${{ steps.find.outputs.target }}

      - name: Upload Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: qa-reports
          path: qa_report.log