name: Universal QA System

on:
  push:
    paths:
      - 'docker/**'
      - '**.cpp'
      - '**.py'
      - '**.m'    # Supporto Octave/Matlab
      - '**.tex'  # Supporto LaTeX

jobs:
  qa-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Codice
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      # Identifica il file modificato (Supporta cpp, py, m, tex) e previene crash Git
      - name: Trova File Modificato
        id: find
        continue-on-error: true
        run: |
          # Cerca tra cpp, py, m, tex ma ignora modifiche dentro la cartella docker/
          TARGET=$(git diff --name-only HEAD^ HEAD 2>/dev/null | grep -v "docker/" | grep -E '\.(cpp|py|m|tex)$' | head -1) || true
          
          # Fallback: se non trova nulla (es. primo push), non rompere tutto
          if [ -z "$TARGET" ]; then
             echo "Nessun file target trovato o modifica solo interna a docker."
          else
             echo "File individuato: $TARGET"
             echo "target=$TARGET" >> $GITHUB_OUTPUT
          fi

      # Build Locale (Veloce e senza login/permessi)
      - name: Build Engine
        if: steps.find.outputs.target != ''
        run: docker build -t qa-engine ./docker

      # Esecuzione Tester
      - name: Run Engine
        if: steps.find.outputs.target != ''
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/app \
            qa-engine ${{ steps.find.outputs.target }}

      - name: Upload Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: reports
          path: "*.log"