name: Universal QA System

on:
  push:
    paths:
      - 'docker/**'
      - '**.cpp'
      - '**.py'
      - '**.m'    # Supporto Octave/Matlab
      - '**.tex'  # Supporto LaTeX

jobs:
  qa-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Codice
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      # --- QUI C'È LA MODIFICA FONDAMENTALE (IL PARACADUTE) ---
      - name: Trova File Modificato
        id: find
        continue-on-error: true
        run: |
          # Tentativo 1: Chiediamo a Git cosa è cambiato
          TARGET=$(git diff --name-only HEAD^ HEAD 2>/dev/null | grep -v "docker/" | grep -E '\.(cpp|py|m|tex)$' | head -1) || true
          
          # Tentativo 2 (PARACADUTE): Se Git non risponde, cerchiamo noi il file nella cartella!
          if [ -z "$TARGET" ]; then
             echo "⚠️ Git non ha trovato modifiche. Cerco file manualmente..."
             # Cerca un file .cpp, .py, .m o .tex che NON sia il tester.cpp
             TARGET=$(find . -maxdepth 1 -type f | grep -E '\.(cpp|py|m|tex)$' | grep -v "tester.cpp" | head -1 | sed 's|./||')
          fi

          if [ -z "$TARGET" ]; then
             echo "❌ Nessun file da testare trovato."
          else
             echo "✅ File individuato: $TARGET"
             echo "target=$TARGET" >> $GITHUB_OUTPUT
          fi
      # ---------------------------------------------------------

      # Build Locale (Veloce, nessun login richiesto)
      - name: Build Engine
        if: steps.find.outputs.target != ''
        run: docker build -t qa-engine ./docker

      # Esecuzione Tester
      - name: Run Engine
        if: steps.find.outputs.target != ''
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/app \
            qa-engine ${{ steps.find.outputs.target }}

      - name: Upload Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: reports
          path: "*.log"